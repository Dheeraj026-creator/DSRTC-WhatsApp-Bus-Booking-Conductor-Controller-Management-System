<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>All Buses</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />

  <style>
    .secret-key {
      font-family: monospace;
      background-color: #f8f9fa;
      padding: 5px 10px;
      border-radius: 5px;
      display: inline-block;
      word-break: break-all;
    }
    .welcome {
      font-weight: 500;
      color: #198754;
    }
    .trip-over {
      background-color: #dc3545;
      color: white;
      font-weight: bold;
      text-align: center;
      border-radius: 10px;
      padding: 5px 0;
      margin-bottom: 10px;
    }
    .current-time {
      font-weight: 600;
      color: #0d6efd;
    }
  </style>
</head>

<body>
  <div class="container mt-4">

    <!-- Current Time Display -->
    <div class="text-center mb-3">
      <h5>🕒 Current Time: <span id="currentTime" class="current-time"></span></h5>
    </div>

    <!-- Header Section -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2>🚌 All Buses 🏯 Mysuru ↔️ 🏙️ Bengaluru</h2>

      <div class="d-flex align-items-center gap-2">
        <% if (user) { %>
          <span class="welcome me-2">Welcome, <%= user.username || 'Admin' %> 👋</span>
          <a href="/logout" class="btn btn-outline-danger btn-sm">Logout</a>
        <% } else { %>
          <a href="/login" class="btn btn-outline-primary btn-sm">Login</a>
        <% } %>

        <a href="/admin" class="btn btn-primary">Add New Bus</a>
      </div>
    </div>

    <!-- 🔍 Search Bar -->
    <div class="mb-4">
      <input
        type="text"
        id="searchInput"
        class="form-control"
        placeholder="Search bus by number, driver, or city..."
        onkeyup="filterBuses()"
      >
    </div>

    <!-- Bus Cards -->
    <div class="row" id="busContainer">
      <% if (buses.length === 0) { %>
        <div class="text-center">
          <p class="text-muted">No buses added yet.</p>
        </div>
      <% } else { %>
        <% buses.forEach(bus => { %>
          <div class="col-md-4 mb-4 bus-card">
            <div class="card shadow-sm h-100 position-relative" data-arrival="<%= bus.arrivalTime %>">

              <!-- 🚫 Trip Over Label -->
              <div class="trip-over d-none" id="tripOver-<%= bus._id %>">🚫 Trip Over</div>

              <div class="card-body">
                <h5 class="card-title bus-number"><%= bus.busNumber %></h5>
                <p class="card-text">
                  <strong>Driver:</strong> <span class="driver-name"><%= bus.driverName %></span><br>
                  <strong>Phone:</strong> <%= bus.driverPhone %><br>
                  <strong>Seats:</strong> <%= bus.totalSeats %><br>
                  <strong>Departure:</strong> <span class="departure-city"><%= bus.departureCity %></span> (<%= bus.departureTime %>)<br>
                  <strong>Arrival:</strong> <span class="arrival-city"><%= bus.arrivalCity %></span> (<%= bus.arrivalTime %>)<br>
                  <strong>Secret Key:</strong>
                  <span class="secret-key" id="key-<%= bus._id %>"><%= bus.secretKey %></span>
                  <button class="btn btn-sm btn-outline-secondary ms-2" onclick="copyKey('<%= bus._id %>')">
                    📋 Copy
                  </button>
                </p>
              </div>

              <!-- Buttons Section -->
              <div class="card-footer bg-white border-0 d-flex justify-content-between align-items-center">
                <% if (user) { %>
                  <a href="/admin/edit/<%= bus._id %>" class="btn btn-sm btn-warning">✏️ Edit</a>

                  

                  <form action="/admin/delete/<%= bus._id %>" method="POST" onsubmit="return confirm('Delete this bus?')">
                    <button type="submit" class="btn btn-sm btn-danger">🗑️ Delete</button>
                  </form>
                <% } else { %>
                  <small class="text-muted">Login to manage</small>
                <% } %>
              </div>
            </div>
          </div>
        <% }) %>
      <% } %>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // ✅ Display current live time
    function updateCurrentTime() {
      const now = new Date();
      const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      document.getElementById("currentTime").textContent = timeString;
    }
    setInterval(updateCurrentTime, 1000);
    updateCurrentTime();

    // ✅ Check each bus and mark "Trip Over" if arrival time < current time
    function checkTripStatus() {
      const now = new Date();
      const currentMinutes = now.getHours() * 60 + now.getMinutes();

      document.querySelectorAll('.card[data-arrival]').forEach(card => {
        const arrival = card.getAttribute('data-arrival');
        if (arrival) {
          const [hours, mins] = arrival.split(':').map(Number);
          const arrivalMinutes = hours * 60 + mins;

          const tripOverEl = card.querySelector('.trip-over');
          if (currentMinutes >= arrivalMinutes) {
            tripOverEl.classList.remove('d-none');
          } else {
            tripOverEl.classList.add('d-none');
          }
        }
      });
    }

    // Check every minute
    setInterval(checkTripStatus, 60000);
    checkTripStatus();

    // ✅ Copy Secret Key
    function copyKey(id) {
      const key = document.getElementById(`key-${id}`).innerText;
      navigator.clipboard.writeText(key)
        .then(() => alert("Secret key copied!"))
        .catch(err => console.error("Failed to copy:", err));
    }

    // 🔍 Search Filter
    function filterBuses() {
      const input = document.getElementById('searchInput').value.toLowerCase();
      const busCards = document.querySelectorAll('.bus-card');

      busCards.forEach(card => {
        const busNumber = card.querySelector('.bus-number').innerText.toLowerCase();
        const driverName = card.querySelector('.driver-name').innerText.toLowerCase();
        const departureCity = card.querySelector('.departure-city').innerText.toLowerCase();
        const arrivalCity = card.querySelector('.arrival-city').innerText.toLowerCase();

        if (
          busNumber.includes(input) ||
          driverName.includes(input) ||
          departureCity.includes(input) ||
          arrivalCity.includes(input)
        ) {
          card.style.display = 'block';
        } else {
          card.style.display = 'none';
        }
      });
    }
  </script>
</body>
</html>
